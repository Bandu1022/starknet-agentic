---
title: DeFi Skill
description: Execute token swaps, DCA orders, staking, and DeFi operations
---

# DeFi Skill

The `starknet-defi` skill enables AI agents to execute DeFi operations on Starknet using the AVNU aggregator. Swap tokens with best-price routing, set up DCA orders, stake STRK, and interact with lending protocols.

<Callout type="tip" title="Best Price Routing">
AVNU aggregates liquidity across all Starknet DEXs (Ekubo, JediSwap, etc.) to find the optimal route for every swap.
</Callout>

## Installation

```bash
npm install starknet@^8.9.1 @avnu/avnu-sdk@^4.0.1
```

## Configuration

| Variable | Required | Description |
|----------|----------|-------------|
| `STARKNET_RPC_URL` | Yes | Starknet JSON-RPC endpoint |
| `STARKNET_ACCOUNT_ADDRESS` | Yes | Agent's account address |
| `STARKNET_PRIVATE_KEY` | Yes | Agent's signing key |
| `AVNU_BASE_URL` | No | `https://starknet.api.avnu.fi` (default) |
| `AVNU_PAYMASTER_URL` | No | `https://starknet.paymaster.avnu.fi` (default) |

## Token Swaps

### Get Quote and Execute

```typescript
import { getQuotes, executeSwap, type QuoteRequest } from "@avnu/avnu-sdk";
import { Account, RpcProvider, ETransactionVersion } from "starknet";
import { fetchVerifiedTokenBySymbol } from '@avnu/avnu-sdk';

const provider = new RpcProvider({ nodeUrl: process.env.STARKNET_RPC_URL });

const account = new Account({
  provider,
  address: process.env.STARKNET_ACCOUNT_ADDRESS,
  signer: process.env.STARKNET_PRIVATE_KEY,
  transactionVersion: ETransactionVersion.V3,
});

// Resolve token addresses
const eth = await fetchVerifiedTokenBySymbol('ETH');
const strk = await fetchVerifiedTokenBySymbol('STRK');

// Get quote
const quoteParams: QuoteRequest = {
  sellTokenAddress: eth.address,
  buyTokenAddress: strk.address,
  sellAmount: BigInt(10 ** 17), // 0.1 ETH
  takerAddress: account.address,
};

const quotes = await getQuotes(quoteParams);
const bestQuote = quotes[0];

// Execute swap
const result = await executeSwap({
  provider: account,
  quote: bestQuote,
  slippage: 0.01, // 1%
  executeApprove: true,
});

console.log("Transaction:", result.transactionHash);
```

### Quote Response

```typescript
interface Quote {
  quoteId: string;
  sellTokenAddress: string;
  buyTokenAddress: string;
  sellAmount: bigint;
  buyAmount: bigint;
  sellAmountInUsd: number;
  buyAmountInUsd: number;
  priceImpact: number;      // Basis points (15 = 0.15%)
  gasFeesInUsd: number;
  routes: Array<{
    name: string;           // "Ekubo", "JediSwap", etc.
    percent: number;        // 0.8 = 80%
  }>;
}
```

### Gasless Swap

Pay gas in any token instead of ETH/STRK:

```typescript
import { getQuotes, executeSwap } from "@avnu/avnu-sdk";
import { PaymasterRpc } from "starknet";

const paymaster = new PaymasterRpc({
  nodeUrl: "https://starknet.paymaster.avnu.fi",
});

const result = await executeSwap({
  provider: account,
  quote: bestQuote,
  slippage: 0.01,
  executeApprove: true,
  paymaster: {
    active: true,
    provider: paymaster,
    params: {
      feeMode: {
        mode: "default",
        gasToken: "0x053c91253bc9682c04929ca02ed00b3e423f6710d2ee7e0d5ebb06f3ecf368a8", // USDC
      },
    },
  },
});
```

### Build Swap Calls (for Multicall)

```typescript
import { quoteToCalls } from "@avnu/avnu-sdk";

const calls = await quoteToCalls({
  quote: bestQuote,
  takerAddress: account.address,
  slippage: 0.01,
  includeApprove: true,
});

// Combine with other calls
await account.execute([...calls, ...otherCalls]);
```

## DCA (Dollar Cost Averaging)

### Create DCA Order

```typescript
import { executeCreateDca } from "@avnu/avnu-sdk";
import moment from "moment";

const dcaOrder = {
  sellTokenAddress: usdcAddress,
  buyTokenAddress: strkAddress,
  totalAmount: BigInt(100 * 10**6),  // 100 USDC
  numberOfOrders: 10,                 // Split into 10 orders
  frequency: moment.duration(1, "day"),
  startAt: Math.floor(Date.now() / 1000),
};

const result = await executeCreateDca({
  provider: account,
  order: dcaOrder,
});
```

### Manage DCA Orders

```typescript
import { getDcaOrders, executeCancelDca, DcaOrderStatus } from "@avnu/avnu-sdk";

// List active orders
const orders = await getDcaOrders({
  traderAddress: account.address,
  status: DcaOrderStatus.OPEN,
});

// Cancel an order
await executeCancelDca({
  provider: account,
  orderAddress: orders[0].orderAddress,
});
```

## STRK Staking

### Stake STRK

```typescript
import { executeStake, getAvnuStakingInfo } from "@avnu/avnu-sdk";

// Get pool info
const stakingInfo = await getAvnuStakingInfo();
// stakingInfo.pools[0] = { address, apy, tvl, token, minStake }

const result = await executeStake({
  provider: account,
  poolAddress: stakingInfo.pools[0].address,
  amount: BigInt(100 * 10**18), // 100 STRK
});
```

### Check Staking Position

```typescript
import { getUserStakingInfo } from "@avnu/avnu-sdk";

const userInfo = await getUserStakingInfo(TOKENS.STRK, account.address);
console.log("Staked:", userInfo.amount);
console.log("Unclaimed rewards:", userInfo.unclaimedRewards);
```

### Claim Rewards

```typescript
import { executeClaimRewards } from "@avnu/avnu-sdk";

// Claim and restake (compound)
await executeClaimRewards({
  provider: account,
  poolAddress: poolAddress,
  restake: true,
});
```

### Unstake

```typescript
import { executeInitiateUnstake, executeUnstake } from "@avnu/avnu-sdk";

// Step 1: Initiate (21-day cooldown for STRK)
await executeInitiateUnstake({
  provider: account,
  poolAddress: poolAddress,
  amount: BigInt(50 * 10**18),
});

// Step 2: Complete after cooldown
await executeUnstake({
  provider: account,
  poolAddress: poolAddress,
});
```

## Market Data

### Token Prices

```typescript
import { getPrices, fetchTokens, fetchVerifiedTokenBySymbol } from "@avnu/avnu-sdk";

// Get token by symbol
const strk = await fetchVerifiedTokenBySymbol("STRK");

// Get prices for multiple tokens
const prices = await getPrices([ethAddress, strkAddress, usdcAddress]);
// { "0x049d...": 3200.50, "0x047...": 1.23, ... }

// Browse verified tokens
const tokens = await fetchTokens({ page: 0, size: 20, tags: ["verified"] });
```

## Protocol Reference

| Protocol | Operations | Notes |
|----------|-----------|-------|
| **AVNU** | Swap aggregation, DCA, gasless | Best-price routing across all DEXs |
| **Ekubo** | AMM, concentrated liquidity | Highest TVL on Starknet |
| **JediSwap** | AMM, classic pools | V2 with concentrated liquidity |
| **zkLend** | Lending, borrowing | Variable and stable rates |
| **Nostra** | Lending, borrowing | Multi-asset pools |

## AVNU URL Reference

| Network | API URL | Paymaster URL |
|---------|---------|---------------|
| Mainnet | `https://starknet.api.avnu.fi` | `https://starknet.paymaster.avnu.fi` |
| Sepolia | `https://sepolia.api.avnu.fi` | `https://sepolia.paymaster.avnu.fi` |

## Error Handling

```typescript
async function safeSwap(account, quote, slippage = 0.01) {
  try {
    return await executeSwap({
      provider: account,
      quote,
      slippage,
      executeApprove: true,
    });
  } catch (error) {
    if (error.message?.includes("INSUFFICIENT_BALANCE")) {
      throw new Error("Not enough tokens for swap");
    }
    if (error.message?.includes("SLIPPAGE")) {
      // Retry with higher slippage
      return await executeSwap({
        provider: account,
        quote,
        slippage: slippage * 2,
        executeApprove: true,
      });
    }
    if (error.message?.includes("QUOTE_EXPIRED")) {
      throw new Error("Quote expired. Please retry.");
    }
    throw error;
  }
}
```

## References

- [AVNU SDK Documentation](https://docs.avnu.fi/)
- [Ekubo Protocol](https://docs.ekubo.org/)
- [zkLend Documentation](https://docs.zklend.com/)
- [Nostra Finance](https://docs.nostra.finance/)
